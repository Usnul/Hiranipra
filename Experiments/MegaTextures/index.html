<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Hiranipra Megatextures Experiment</title>

    <script type="text/javascript" src="../../Dependencies/jquery-1.3.2.min.js"></script>

    <script type="text/javascript" src="../../Shared/HNUtil.js"></script>

    <script type="text/javascript" src="../../Shared/HNConsole.js"></script>

    <script type="text/javascript" src="../../Shared/HNConfig.js"></script>

    <script type="text/javascript" src="../../Shared/HNShell.js"></script>

    <script type="text/javascript" src="../../Shared/HNMath.js"></script>

    <script type="text/javascript" src="../../Shared/HNKeyboard.js"></script>

    <script type="text/javascript" src="../../Shared/HNFPSCamera.js"></script>

    <script type="text/javascript" src="../../Shared/HNTimer.js"></script>

    <script type="text/javascript" src="../../Shared/HNProfileGraph.js"></script>

    <script type="text/javascript" src="../../Shared/GL/HNGL.js"></script>

    <script type="text/javascript" src="../../Shared/GL/HNGLProgram.js"></script>

    <script type="text/javascript" src="../../Shared/GL/HNGLGrid.js"></script>

    <script type="text/javascript" src="../../Shared/GL/HNGLQuadDrawer.js"></script>

    <script type="text/javascript" src="../../Shared/GL/HNGLFeedbackBuffer.js"></script>

    <script type="text/javascript" src="../../Shared/GL/HNGLGeometry.js"></script>

    <script type="text/javascript" src="../../Shared/MegaTextures/HNMegaTextureTile.js"></script>

    <script type="text/javascript" src="../../Shared/MegaTextures/HNMegaTexture.js"></script>

    <script type="text/javascript" src="../../Shared/MegaTextures/HNMegaTextureLoader.js"></script>

    <script type="text/javascript" src="../../Shared/MegaTextures/HNMegaTextureCache.js"></script>

    <script type="text/javascript" src="../../Shared/MegaTextures/HNMegaTextureShaders.js"></script>

    <script id="simple-mt-vs" type="x-shader/x-vertex">
        uniform mat4 u_viewProjMatrix;
        uniform mat4 u_modelMatrix;
        attribute vec3 a_pos;
        attribute vec2 a_tex0;
        varying vec2 v_tex0;
        void main() {
            gl_Position = ( u_viewProjMatrix * u_modelMatrix ) * vec4( a_pos, 1.0 );
            v_tex0 = a_tex0;
        }
    </script>

    <script id="wavey-mt-vs" type="x-shader/x-vertex">
        uniform mat4 u_viewProjMatrix;
        uniform mat4 u_modelMatrix;
        uniform float u_time;
        attribute vec3 a_pos;
        attribute vec2 a_tex0;
        varying vec2 v_tex0;
        void main() {
            float x = length( a_pos ) * sin( u_time / 2.0 ) * 25.0;
            gl_Position = ( u_viewProjMatrix * u_modelMatrix ) * vec4( a_pos.x, sin( x / 2.0 ) * 20.0, a_pos.z, 1.0 );
            v_tex0 = a_tex0;
        }
    </script>

    <script id="simple-mt-pass1fs" type="x-shader/x-fragment">
        varying vec2 v_tex0;
        void main() {
            gl_FragColor = MTCalculateTileKeyRGBA( v_tex0 );
        }
    </script>

    <script id="simple-mt-pass2fs" type="x-shader/x-fragment">
        varying vec2 v_tex0;
        void main() {
            //gl_FragColor = MTSampleBilinear( v_tex0 );
            gl_FragColor = MTSampleTrilinear( v_tex0 );
        }
    </script>

    <script type="text/javascript">
        var app = {};
        app.initialize = function(displayCanvas, profileGraphCanvas, profileGraphText) {
            app.startTime = (new Date().getTime());
            if (profileGraphCanvas) {
                this.profileGraph = new HNProfileGraph(200, 20, profileGraphCanvas);
                this.profileGraphText = profileGraphText;
            }

            this.gl = HNGLCreate(displayCanvas);
            if (!this.gl) {
                return;
            }

            this.displayCanvas = displayCanvas;
            this.keyboard = new HNKeyboard();
            this.camera = new HNFPSCamera();
            this.camera.resize(displayCanvas.width, displayCanvas.height);
            this.camera.znear = 0.1;
            this.camera.zfar = 10000.0;

            this.viewProjStack = new HNMatrixStack4x4();
            this.modelStack = new HNMatrixStack4x4();

            if (!this.loadAssets()) {
                return;
            }

            this.updateFrameNumber = 0;
            this.renderFrameNumber = 0;

            this.timer = new HNTimer([this, this.update], [this, this.render]);
            this.timer.start();
        }

        app.loadAssets = function() {
            var gl = app.gl;
            try {
                con.beginGroup("App - loading assets");

                this.grid = new HNGLGrid(gl, 25, 100);
                this.quadDrawer = new HNGLQuadDrawer(gl);

                con.beginGroup("App - initializing a debug megatexture");
                if (true) {
                    this.megaTexture = new HNDeepZoomMegaTexture(
                        255,
                        '<?xml version="1.0" encoding="UTF-8"?><Image TileSize="254" Overlap="1" Format="jpg" xmlns="http://schemas.microsoft.com/deepzoom/2008"><Size Width="29566" Height="14321"/></Image>',
                        "http://content.seadragon.com/content/images/CarinaNebula.dzi"
                    );
                } else {
                    this.megaTexture = new HNTestMegaTexture(255, 65536, 65536, 254, 1);
                }
                con.endGroup();

                con.beginGroupCollapsed("HNMT - initializing megatexture loader");
                this.megaTextureLoader = new HNMegaTextureLoader();
                con.endGroup();

                con.beginGroup("HNMT - initializing megatexture cache");
                // NOTE: normally we would pick some size we know is right - here, we are taking whatever we are getting from the texture
                this.megaTextureCache = new HNMegaTextureCache(gl, this.megaTexture.tileSize, this.megaTexture.tileOverlap, 12);
                con.endGroup();

                con.beginGroup("HNMT - initializing feedback buffer")
                this.feedbackBuffer = new HNGLFeedbackBuffer(gl, 16);
                this.feedbackBuffer.resize(this.displayCanvas.width, this.displayCanvas.height);
                con.endGroup();

                this.megaTextureCache.registerMegaTexture(this.megaTexture);

                con.beginGroup("App - initializing a debug object");
                //this.obj = HNGLGeometry.quad(gl);
                this.obj = HNGLGeometry.segmentedQuad(gl, 32);
                con.endGroup();

                // Create our dummy programs
                var simplevs = $("#simple-mt-vs").text();
                //var simplevs = $("#wavey-mt-vs").text();
                this.staticProgram = {
                    pass1: HNGLProgram.fromSources(gl,
                        HNMegaTextureShaders.prependPass1vs(simplevs),
                        HNMegaTextureShaders.prependPass1fs($("#simple-mt-pass1fs").text())
                    ),
                    pass2: HNGLProgram.fromSources(gl,
                        HNMegaTextureShaders.prependPass2vs(simplevs),
                        HNMegaTextureShaders.prependPass2fs($("#simple-mt-pass2fs").text())
                    )
                };
                this.staticProgram.pass1.begin = function(viewProjMatrix, modelMatrix) {
                    gl.useProgram(this.id);
                    gl.uniformMatrix4fv(this.u_viewProjMatrix, false, viewProjMatrix.asArray());
                    gl.uniformMatrix4fv(this.u_modelMatrix, false, modelMatrix.asArray());
                    gl.uniform1f(this.u_time, (new Date().getTime() - app.startTime) / 1000.0);
                    gl.enableVertexAttribArray(this.a_pos);
                    gl.enableVertexAttribArray(this.a_tex0);
                };
                this.staticProgram.pass1.end = function() {
                    gl.disableVertexAttribArray(this.a_tex0);
                    gl.disableVertexAttribArray(this.a_pos);
                    //gl.useProgram(null);
                };
                this.staticProgram.pass2.begin = function(viewProjMatrix, modelMatrix) {
                    gl.useProgram(this.id);
                    gl.uniformMatrix4fv(this.u_viewProjMatrix, false, viewProjMatrix.asArray());
                    gl.uniformMatrix4fv(this.u_modelMatrix, false, modelMatrix.asArray());
                    gl.uniform1f(this.u_time, (new Date().getTime() - app.startTime) / 1000.0);
                    gl.enableVertexAttribArray(this.a_pos);
                    gl.enableVertexAttribArray(this.a_tex0);
                };
                this.staticProgram.pass2.end = function() {
                    gl.disableVertexAttribArray(this.a_tex0);
                    gl.disableVertexAttribArray(this.a_pos);
                    //gl.useProgram(null);
                };

                return true;
            } finally {
                con.endGroup();
            }
        }

        app.update = function(delta) {
            this.updateInput(delta);
            this.camera.update(delta);
        }

        app.updateInput = function(delta) {
            // ---- Check for some magic key presses ----
            if ((this.keyboard.isDown(116)) || // F5
                (this.keyboard.isDown(17) && this.keyboard.isDown(82))) // ctrl + r
            {
                // Reload the page
                this.timer.stop();
                this.keyboard.clear();
                window.location.reload();
                return;
            }
            if ((this.keyboard.isDown(27))) // esc
            {
                // Stop/start the timer
                if (this.timer.active) {
                    con.info("pausing...");
                    this.timer.stop();
                    this.keyboard.clear();
                    // Begin our own check to see when we should resume
                    var resumeObj = new Object();
                    resumeObj.intervalId = window.setInterval(function() {
                        if (app.keyboard.isDown(27)) {
                            window.clearInterval(resumeObj.intervalId);
                            app.keyboard.clear();
                            con.info("resuming");
                            app.timer.start();
                        }
                    }, 100);
                } else {
                    con.info("resuming");
                    this.timer.start();
                }
            }

            // ---- Update camera ----
            this.camera.updateInput(delta, this.keyboard);
        }

        app.render = function(delta) {
            var startTime = (new Date().getTime());
            this.renderFrameNumber++;

            var gl = app.gl;

            {
                var completedTiles = this.megaTextureLoader.getCompletedTiles();
                if (completedTiles.length > 0) {
                    this.megaTextureCache.beginUpdate(this.renderFrameNumber);
                    this.megaTextureCache.removeUnusedTiles();
                    for (var n = 0; n < completedTiles.length; n++) {
                        this.megaTextureCache.addTile(completedTiles[n]);
                    }
                    this.megaTextureCache.endUpdate();
                }
                delete completedTiles;
            }

            gl.viewport(0, 0, this.displayCanvas.width, this.displayCanvas.height);
            gl.clearColor(0.15, 0.15, 0.15, 1);
            gl.clearDepth(1.0);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
            gl.disable(gl.BLEND);
            gl.enable(gl.DEPTH_TEST);
            gl.depthFunc(gl.LEQUAL);

            this.viewProjStack.load(this.camera.viewMatrix);
            this.viewProjStack.multiplyBy(this.camera.projMatrix);
            this.modelStack.loadIdentity();

            this.grid.draw(this.viewProjStack.current, 1.0);

            this.feedbackBuffer.begin();
            var lastFrameFeedbackData = this.feedbackBuffer.readPixels();
            gl.clearColor(0, 0, 0, 0);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
            gl.enable(gl.BLEND);
            gl.enable(gl.DEPTH_TEST);
            gl.depthFunc(gl.LEQUAL);
            {
                this.modelStack.push();
                this.modelStack.translate(0, 1, 0);
                this.modelStack.scale(2000, 1, 2000 / (this.megaTexture.width / this.megaTexture.height));
                //this.modelStack.scale(this.megaTexture.width, 1, this.megaTexture.height);
                this.staticProgram.pass1.begin(this.viewProjStack.current, this.modelStack.current);
                gl.uniform1f(this.staticProgram.pass1.u_mt_bias, -Math.log(this.feedbackBuffer.downsample) / Math.log(2));
                gl.uniform4f(this.staticProgram.pass1.u_mt_tex, this.megaTexture.width, this.megaTexture.height, this.megaTexture.tileSize, this.megaTexture.uniqueId);
                this.obj.draw([this.staticProgram.pass1.a_pos, this.staticProgram.pass1.a_tex0]);
                this.staticProgram.pass1.end();
                this.modelStack.pop();
            }
            this.feedbackBuffer.end();

            gl.disable(gl.BLEND);
            gl.enable(gl.DEPTH_TEST);
            gl.depthFunc(gl.LEQUAL);

            {
                this.modelStack.push();
                this.modelStack.translate(0, 1, 0);
                this.modelStack.scale(2000, 1, 2000 / (this.megaTexture.width / this.megaTexture.height));
                //this.modelStack.scale(this.megaTexture.width, 1, this.megaTexture.height);
                this.staticProgram.pass2.begin(this.viewProjStack.current, this.modelStack.current);
                gl.uniform4f(this.staticProgram.pass2.u_mt_tex, this.megaTexture.width, this.megaTexture.height, this.megaTexture.tileSize, this.megaTexture.uniqueId);
                gl.uniform4f(this.staticProgram.pass2.u_mt_texCache, this.megaTextureCache.width, this.megaTextureCache.height, this.megaTextureCache.lookup.width, this.megaTextureCache.lookup.height);
                gl.uniform4f(this.staticProgram.pass2.u_mt_slot, 0, 0, this.megaTextureCache.tileOverlap, 0);
                gl.uniform1i(this.staticProgram.pass2.s_mt_lookup, 0);
                gl.uniform1i(this.staticProgram.pass2.s_mt_texCache, 1);
                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D, this.megaTextureCache.lookup.texture);
                gl.activeTexture(gl.TEXTURE1);
                gl.bindTexture(gl.TEXTURE_2D, this.megaTextureCache.texture);
                gl.activeTexture(gl.TEXTURE0);
                this.obj.draw([this.staticProgram.pass2.a_pos, this.staticProgram.pass2.a_tex0]);
                this.staticProgram.pass2.end();
                this.modelStack.pop();
            }

            // Draw debug megatexture stuff
            gl.enable(gl.BLEND);
            gl.disable(gl.DEPTH_TEST);
            this.quadDrawer.beginBatch(this.displayCanvas.width, this.displayCanvas.height);
            this.quadDrawer.draw(this.feedbackBuffer.texture, 0, 0, 128, 128 / (this.displayCanvas.width / this.displayCanvas.height), true);
            this.quadDrawer.draw(this.megaTextureCache.texture, 0, 128, 128, 128, true);
            this.quadDrawer.draw(this.megaTextureCache.lookup.texture, 0, 256, 128, 128 / (this.megaTextureCache.lookup.width / this.megaTextureCache.lookup.height), true);
            this.quadDrawer.endBatch();

            if (lastFrameFeedbackData) {
                this.megaTextureCache.processFeedbackData(lastFrameFeedbackData, this.renderFrameNumber, this.megaTextureLoader);
            }

            if (this.profileGraph) {
                var endTime = ((new Date().getTime()) - startTime);
                this.profileGraph.beginUpdate();
                this.profileGraph.addSample(endTime, 16.7777);
                this.profileGraph.endUpdate();
                this.profileGraphText.text(endTime + "ms");
            }
        }

        function onLoad() {
            app.initialize(
                $("#displayCanvas").get()[0],
                $("#profileGraphCanvas").get()[0], $("#profileGraphText")
            );
        }
    </script>

</head>
<body onload="onLoad();">
    <canvas id="displayCanvas" width="800" height="600"></canvas>
    <br />
    <br />
    <canvas id="profileGraphCanvas" style="border: 1px; border-color: grey; border-style: solid;"></canvas>
    <span id="profileGraphText"></span>
</body>
</html>
