<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Hiranipra Tiled Maps Experiment</title>

    <script type="text/javascript" src="../../Dependencies/jquery-1.3.2.min.js"></script>

    <script type="text/javascript" src="../../Shared/HNUtil.js"></script>

    <script type="text/javascript" src="../../Shared/HNConsole.js"></script>

    <script type="text/javascript" src="../../Shared/HNConfig.js"></script>

    <script type="text/javascript" src="../../Shared/HNShell.js"></script>

    <script type="text/javascript" src="../../Shared/HNMath.js"></script>

    <script type="text/javascript" src="../../Shared/HNKeyboard.js"></script>

    <script type="text/javascript" src="../../Shared/HNTimer.js"></script>

    <script type="text/javascript" src="../../Shared/HNProfileGraph.js"></script>
    
    <script type="text/javascript" src="../../Shared/HN2DViewport.js"></script>

    <script type="text/javascript">
        var app = {};
        app.initialize = function(displayCanvas, profileGraphCanvas, profileGraphText) {
            this.displayCanvas = displayCanvas;

            if (!this.loadAssets()) {
                return;
            }

            if (profileGraphCanvas) {
                this.profileGraph = new HNProfileGraph(200, 20, profileGraphCanvas);
                this.profileGraphText = profileGraphText;
            }

            this.keyboard = new HNKeyboard();
            this.camera = {
                x: 0,
                y: 0
            };

            this.timer = new HNTimer([this, this.update], [this, this.render]);
            this.timer.start();
        }

        app.loadAssets = function() {
            try {
                con.beginGroup("App - loading assets");

                this.tileSheet = document.createElement("img");
                this.tileSheet.src = "Tiles.png";

                this.map = {
                    width: 1024,
                    height: 1024,
                    tileSize: 32,
                    tiles: []
                };
                this.map.tiles[this.map.width * this.map.height] = 0;
                for (var y = 0; y < this.map.height; y++) {
                    for (var x = 0; x < this.map.width; x++) {
                        this.map.tiles[(y * this.map.width) + x] = Math.floor(Math.random() * 4);
                    }
                }

                return true;
            } finally {
                con.endGroup();
            }
        }

        app.update = function(delta) {
            this.updateInput(delta);
        }

        app.updateInput = function(delta) {
            // ---- Check for some magic key presses ----
            if ((this.keyboard.isDown(116)) || // F5
                (this.keyboard.isDown(17) && this.keyboard.isDown(82))) // ctrl + r
            {
                // Reload the page
                this.timer.stop();
                this.keyboard.clear();
                window.location.reload();
                return;
            }
            if ((this.keyboard.isDown(27))) // esc
            {
                // Stop/start the timer
                if (this.timer.active) {
                    con.info("pausing...");
                    this.timer.stop();
                    this.keyboard.clear();
                    // Begin our own check to see when we should resume
                    var resumeObj = new Object();
                    resumeObj.intervalId = window.setInterval(function() {
                        if (app.keyboard.isDown(27)) {
                            window.clearInterval(resumeObj.intervalId);
                            app.keyboard.clear();
                            con.info("resuming");
                            app.timer.start();
                        }
                    }, 100);
                } else {
                    con.info("resuming");
                    this.timer.start();
                }
            }

            // ---- Update camera ----
        }

        app.render = function(delta) {
            var startTime = (new Date().getTime());

            var ctx = this.displayCanvas.getContext("2d");
            ctx.fillStyle = "rgb(0,0,0)";
            ctx.fillRect(0, 0, this.displayCanvas.width, this.displayCanvas.height);

            ctx.mozImageSmoothingEnabled = false;

            var tileSize = this.map.tileSize;
            var minx = Math.max(Math.floor(this.camera.x / tileSize), 0);
            var miny = Math.max(Math.floor(this.camera.y / tileSize), 0);
            var maxx = Math.min(Math.ceil((this.camera.x + this.displayCanvas.width) / tileSize), this.map.width);
            var maxy = Math.min(Math.ceil((this.camera.y + this.displayCanvas.height) / tileSize), this.map.height);

            // TODO: offset
            var offsetx = ((this.camera.x / tileSize) - Math.floor(this.camera.x / tileSize)) * tileSize;
            var offsety = ((this.camera.y / tileSize) - Math.floor(this.camera.y / tileSize)) * tileSize;
            var dx = -offsetx;
            var dy = -offsety;
            for (var y = miny; y <= maxy; y++, dy += tileSize) {
                for (var x = minx; x <= maxx; x++, dx += tileSize) {
                    var tileIndex = this.map.tiles[(y * this.map.width) + x];
                    // TODO: rows
                    var sx = tileIndex * tileSize;
                    var sy = 0;
                    ctx.drawImage(this.tileSheet, sx, sy, tileSize, tileSize, dx, dy, tileSize, tileSize);
                }
                dx = -offsetx;
            }

            if (this.profileGraph) {
                var endTime = ((new Date().getTime()) - startTime);
                this.profileGraph.beginUpdate();
                this.profileGraph.addSample(endTime, 16.7777);
                this.profileGraph.endUpdate();
                this.profileGraphText.innerHTML = endTime + "ms";
            }
        }

        function onLoad() {
            app.initialize(
                $("#displayCanvas").get()[0],
                $("#profileGraphCanvas").get()[0], $("#profileGraphText").get()[0]
            );
        }
    </script>

</head>
<body onload="onLoad();">
    <canvas id="displayCanvas" width="640" height="480"></canvas>
    <br />
    <br />
    <canvas id="profileGraphCanvas" style="border: 1px; border-color: grey; border-style: solid;"></canvas>
    <span id="profileGraphText"></span>
</body>
</html>
